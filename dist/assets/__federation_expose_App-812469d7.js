import{importShared as v}from"./__federation_fn_import.js";const k=(e,t)=>{const o=e.__vccOpts||e;for(const[l,a]of t)o[l]=a;return o},u=await v("axios"),{io:V}=await v("socket.io-client"),{ref:E}=await v("vue"),n=V("https://livestream-backend-ng53ixt7xq-as.a.run.app"),{VueWebRTC:U}=await v("vue-webrtc-v1"),O={name:"demo-component",components:{"vue-webrtc":U},data(){return{el:E(null),roomId:"roomId",hasJoined:!1,videoOn:!0,micOn:!0,mediaRecorder:{},chunks:[],userStream:{},audioContext:null,videoContainer:null,stream:null,dialog:!1,snackbar:!1,isHost:"",streamId:"",textUserStatus:"User Join",isRecording:!1,mediaStream:null}},mounted(){n.on("deleteUser",({roomId:t,sessionId:o})=>{this.roomId===t&&(this.snackbar=!0,this.textUserStatus=`User ( ${o} ) has left the meeting room.`)}),n.on("join",({roomId:t,sessionId:o})=>{this.roomId===t&&(this.snackbar=!0,this.textUserStatus=`User ( ${o} ) has join the meeting room.`)}),n.on("talking",({sessionId:t,isTalking:o})=>{this.videoContainer=document.querySelector(`.video-item video[id='${t}']`),o&&this.videoContainer?this.videoContainer.style.border="thick solid #FF6B35":this.videoContainer&&(this.videoContainer.style.border="none")});const e=window.location.hash;e!=""&&(this.roomId=e.substring(1),this.toggleRoom())},created(){this.audioContext=new window.AudioContext,window.addEventListener("beforeunload",function(e){console.log("event onload create: ",e),e.returnValue="Write something"})},methods:{async onStop(e){console.log("streamId: ",e)},async onDownloadLocal(){this.$refs.webrtc.leave(),this.hasJoined=!1,this.stopListening(),this.mediaRecorder&&this.isRecording&&(this.mediaRecorder.stop(),this.mediaStream&&this.mediaStream.getTracks().forEach(e=>e.stop()),this.isRecording=!1),await u.delete(`https://livestream-backend-ng53ixt7xq-as.a.run.app/users/list/${this.roomId}/${this.userStream.id}`),await u.post("https://livestream-backend-ng53ixt7xq-as.a.run.app/files",{fileName:this.roomId}),n.emit("usersList",{roomId:this.roomId}),n.emit("deleteUser",{roomId:this.roomId,sessionId:this.userStream.id})},pushData(e){this.chunks.push(e.data)},record(){this.mediaRecorder.start()},onHandleVideoOn(){this.videoOn=!this.videoOn,this.userStream.video=this.videoOn,this.userStream.getVideoTracks()[0].enabled=this.videoOn},onHandleMicOn(){this.micOn=!this.micOn,this.userStream.audio=this.micOn,this.userStream.getAudioTracks()[0].enabled=this.micOn,this.micOn?this.startListening(this.userStream.id):this.stopListening(this.userStream.id)},stopListening(e){this.mediaStreamSource&&(this.mediaStreamSource.disconnect(),this.mediaStreamSource=null,this.analyser=null,this.isListening=!1),setTimeout(function(){this.videoContainer=document.querySelector(`.video-item video[id='${e}']`),this.videoContainer&&(this.videoContainer.style.border="none")},1e3)},startListening(e){navigator.mediaDevices.getUserMedia({audio:!0}).then(t=>{this.mediaStreamSource=this.audioContext.createMediaStreamSource(t),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=32,this.mediaStreamSource.connect(this.analyser),this.isListening=!0,this.checkTalking(e)}).catch(t=>{console.error("Error accessing microphone:",t)})},checkTalking(e){const t=this.analyser.frequencyBinCount,o=new Uint8Array(t),l=()=>{if(!this.isListening)return;this.analyser.getByteFrequencyData(o);const a=o.reduce((g,p)=>g+p,0)/t,r=100;setTimeout(function(){this.videoContainer=document.querySelector(`.video-item video[id='${e}']`),a>r&&this.videoContainer?(this.videoContainer.style.border="thick solid #FF6B35",n.emit("talking",{isTalking:!0,sessionId:e})):(this.videoContainer&&(this.videoContainer.style.border="none"),n.emit("talking",{isTalking:!1,sessionId:e}))},1e3),requestAnimationFrame(l)};l()},async toggleRoom(){try{if(this.hasJoined){const{data:e}=await u.get(`https://livestream-backend-ng53ixt7xq-as.a.run.app/users/${this.userStream.id}`);console.log("data: ",e),e.data.isHost?this.dialog=!0:this.onDownloadLocal()}else{await this.$refs.webrtc.join(),this.userStream=this.$refs.webrtc.videoList[0].stream,n.emit("usersList",{roomId:this.roomId}),n.emit("join",{roomId:this.roomId,sessionId:this.userStream.id}),this.startListening(this.userStream.id),this.getUserList();const{data:e}=await u.get(`https://livestream-backend-ng53ixt7xq-as.a.run.app/users/${this.userStream.id}`);console.log("data isHost: ",e,this.userStream.id),this.mediaStream=await navigator.mediaDevices.getDisplayMedia({video:{mediaSource:"screen"},audio:!0,preferCurrentTab:!0}),this.mediaRecorder=new MediaRecorder(this.mediaStream);const t=[];this.mediaRecorder.ondataavailable=o=>{o.data.size>0&&(n.emit("record",{roomId:this.roomId,data:o.data}),t.push(o.data),this.pushData(o))},this.mediaRecorder.start(5e3),this.isRecording=!0,this.hasJoined=!0}}catch(e){alert(e)}},async getUserList(){},screenShare(){try{this.$refs.webrtc.shareScreen()}catch{alert("Screen share not available")}},async addTrack(){try{this.$refs.webrtc.videoList.forEach(t=>{this.userStream.addTrack(t)})}catch(e){alert(e)}},joinedRoom(e){const t=document.createElement("p");t.setAttribute("class","user-video");const o=document.createTextNode(e);t.appendChild(o),setTimeout(function(){const l=document.getElementById(e);l.after(t,l.children[0])},1e3)},shareStarted(e){console.log(e)},leftRoom(e){console.log(e)},async copyClipboard(){const e=window.location.origin;await navigator.clipboard.writeText(`${e}/#${this.roomId}`),alert("Link copied to clipboard!")},async share(){const t={title:"Vere-ai",text:"Join my meeting!",url:`${window.location.origin}/#${this.roomId}`};try{await navigator.share(t)}catch{this.copyClipboard()}},async meetingRoomEndForEveryone(){const{data:e}=await u.delete(`https://livestream-backend-ng53ixt7xq-as.a.run.app/users/list/${this.roomId}/${this.streamId}`);n.emit("deleteUser",{roomId:this.roomId,sessionId:this.userStream.id}),console.log("this.streamId}: ",this.streamId),console.log("meetingRoomEndForEveryone: ",e),this.onDownloadLocal()},async meetingRoomEnd(){const{data:e}=await u.delete(`https://livestream-backend-ng53ixt7xq-as.a.run.app/users/list/${this.roomId}`);n.emit("deleteUser",{roomId:this.roomId,sessionId:this.userStream.id}),console.log("meetingRoomEnd: ",e),this.onDownloadLocal()}}},{resolveComponent:d,createVNode:i,createElementVNode:_,toDisplayString:f,createTextVNode:c,withCtx:s,openBlock:S,createElementBlock:b,createCommentVNode:T}=await v("vue"),q={class:"video-container"},B={key:0,class:"video-webrtc-controls"};function D(e,t,o,l,a,r){const g=d("vue-webrtc"),p=d("v-icon"),m=d("v-btn"),y=d("v-card-title"),w=d("v-card-text"),x=d("v-spacer"),C=d("v-card-actions"),I=d("v-card"),R=d("v-dialog"),L=d("v-snackbar");return S(),b("div",null,[_("div",null,[_("form",null,[_("div",q,[i(g,{id:"call-canvas",roomId:a.roomId,ref:"webrtc",onShareStarted:r.shareStarted,class:"w-full video-webrtc",onShareStopped:r.leftRoom,onLeftRoom:r.leftRoom,onJoinedRoom:r.joinedRoom,width:"100%"},null,8,["roomId","onShareStarted","onShareStopped","onLeftRoom","onJoinedRoom"])]),a.hasJoined?(S(),b("div",B,[i(m,{onClick:r.onHandleVideoOn,class:"mx-2 bg-primary",size:"x-large"},{default:s(()=>[i(p,null,{default:s(()=>[c(f(a.videoOn?"mdi-video-outline":"mdi-video-off-outline"),1)]),_:1})]),_:1},8,["onClick"]),i(m,{onClick:r.onHandleMicOn,class:"mx-2 bg-primary",size:"x-large"},{default:s(()=>[i(p,null,{default:s(()=>[c(f(a.micOn?"mdi-microphone":"mdi-microphone-off"),1)]),_:1})]),_:1},8,["onClick"]),i(m,{onClick:r.toggleRoom,class:"mx-2 bg-red",size:"x-large"},{default:s(()=>[i(p,null,{default:s(()=>[c("mdi-phone-hangup")]),_:1})]),_:1},8,["onClick"]),i(R,{modelValue:a.dialog,"onUpdate:modelValue":t[2]||(t[2]=h=>a.dialog=h),width:"auto"},{default:s(()=>[i(I,null,{default:s(()=>[i(y,{class:"text-h5"},{default:s(()=>[c(" End the call or just leave? ")]),_:1}),i(w,null,{default:s(()=>[c("You can just leave the call if you don't want to end it for everyone else")]),_:1}),i(C,null,{default:s(()=>[i(x),i(m,{variant:"text",onClick:t[0]||(t[0]=h=>r.meetingRoomEnd()),style:{"margin-right":"15px"}},{default:s(()=>[c(" Just leave the call ")]),_:1}),i(m,{variant:"text",onClick:t[1]||(t[1]=h=>r.meetingRoomEndForEveryone())},{default:s(()=>[c(" End the call for everyone ")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),i(L,{modelValue:a.snackbar,"onUpdate:modelValue":t[4]||(t[4]=h=>a.snackbar=h),timeout:3e3},{actions:s(()=>[i(m,{color:"blue",variant:"text",onClick:t[3]||(t[3]=h=>a.snackbar=!1)},{default:s(()=>[c(" Close ")]),_:1})]),default:s(()=>[c(f(a.textUserStatus)+" ",1)]),_:1},8,["modelValue"])])):T("",!0)])])])}const N=k(O,[["render",D]]);const{openBlock:$,createBlock:A}=await v("vue"),J={__name:"App",setup(e){return(t,o)=>($(),A(N))}},j=k(J,[["__scopeId","data-v-6344aba1"]]);export{j as default};
